<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calorie & Weight Tracker</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root {
      --bg: #0f1115; --panel: #171a21; --muted: #9aa4b2; --text: #e6eaf0;
      --accent: #6ee7b7; --danger: #ef4444; --warn: #f59e0b; --good: #10b981;
      --card: #1f2430; --border: #252b36;
    }
    :root.light {
      --bg: #f7f8fb; --panel: #ffffff; --muted: #6b7280; --text: #0b1220;
      --accent: #0ea5e9; --danger: #dc2626; --warn: #d97706; --good: #059669;
      --card: #ffffff; --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.45;
      transition: background 0.2s ease, color 0.2s ease;
    }
    header {
      padding: 16px;
      background: linear-gradient(180deg, #12151c, #0f1115);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 10;
      display: flex; align-items: center; justify-content: space-between;
      gap: 8px;
    }
    :root.light header { background: linear-gradient(180deg, #ffffff, #f7f8fb); }
    header h1 { margin: 0 0 6px; font-size: 20px; letter-spacing: 0.3px; }
    header .sub { color: var(--muted); font-size: 13px; }
    .right { display: flex; gap: 8px; align-items: center; }
    main { padding: 16px; max-width: 980px; margin: 0 auto; }
    .grid { display: grid; gap: 16px; }
    @media (min-width: 760px) { .grid { grid-template-columns: 1.1fr 1fr; } }
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; padding: 16px;
    }
    .card h2 { margin: 0 0 12px; font-size: 16px; letter-spacing: 0.2px; }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="number"], input[type="date"], input[type="text"], select {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid var(--border); background: var(--panel); color: var(--text);
      outline: none;
    }
    input[readonly] { color: #cbd5e1; }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    .btns { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    button {
      background: var(--panel); color: var(--text);
      border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; cursor: pointer;
    }
    button.primary { background: var(--accent); color: #0b1220; font-weight: 600; border: none; }
    button.warn { border-color: var(--warn); color: #fff; }
    button.danger { background: #2b1111; border-color: #3b1111; color: #ffcdcd; }
    :root.light button.danger { background: #fee2e2; border-color: #fecaca; color: #7f1d1d; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .muted { color: var(--muted); font-size: 13px; }
    .kpi { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .kpi .item { border: 1px solid var(--border); background: var(--panel); border-radius: 10px; padding: 10px; text-align: center; }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-size: 18px; font-weight: 600; margin-top: 3px; }
    canvas { background: #0c0f14; border-radius: 10px; }
    :root.light canvas { background: #f1f5f9; }
    .footer { color: var(--muted); font-size: 12px; margin-top: 20px; text-align: center; }
    .toggle-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .toggle-group button.active { outline: 2px solid var(--accent); }
    .table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 13px; }
    .table th, .table td { border-bottom: 1px solid var(--border); padding: 8px 6px; }
    .table th { color: var(--muted); font-weight: 600; text-align: left; }
    .row-3 { display: grid; gap: 12px; grid-template-columns: 1fr 1fr 1fr; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
</head>
<body>
  <header>
    <div>
      <h1>Calorie & Weight Tracker</h1>
      <div class="sub">Fast entry. Automatic date. Local storage. Simple graphs.</div>
    </div>
    <div class="right">
      <label class="muted" for="themeToggle">Theme</label>
      <button id="themeToggle">Toggle Dark/Light</button>
    </div>
  </header>
  <main class="grid">
    <section class="card">
      <h2>Daily Entry</h2>
      <div class="row">
        <div>
          <label for="date">Date</label>
          <input id="date" type="date" readonly />
        </div>
        <div>
          <label for="calories">Calories</label>
          <input id="calories" type="number" inputmode="numeric" placeholder="e.g., 1900" />
        </div>
      </div>
      <div class="row" style="margin-top: 12px;">
        <div>
          <label for="weight">Weight (lbs)</label>
          <input id="weight" type="number" inputmode="decimal" placeholder="e.g., 298.6" />
        </div>
        <div>
          <label for="notes">Notes (optional)</label>
          <input id="notes" placeholder="pizza night / long walk / etc." />
        </div>
      </div>
      <div class="btns">
        <button class="primary" id="saveBtn">Save Today</button>
        <button id="editBtn">Load Today (edit)</button>
        <button class="warn" id="undoBtn">Undo Last</button>
        <button class="danger" id="clearBtn">Clear All</button>
      </div>

      <div class="kpi">
        <div class="item">
          <div class="label">7‑Day Avg Calories</div>
          <div class="value" id="avg7Cal">—</div>
        </div>
        <div class="item">
          <div class="label">Weight Δ (7 days)</div>
          <div class="value" id="delta7Wt">—</div>
        </div>
        <div class="item">
          <div class="label">Entries</div>
          <div class="value" id="entryCount">0</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Graphs</h2>
      <div class="toggle-group" style="margin-bottom:10px;">
        <button id="showWeight" class="active">Weight</button>
        <button id="showCalories">Calories</button>
      </div>

      <div id="weightPanel">
        <canvas id="weightChart" height="220"></canvas>
      </div>
      <div id="calPanel" style="display:none;">
        <div class="toggle-group" style="margin-bottom:8px;">
          <button class="active" data-range="week">Weekly</button>
          <button data-range="month">Monthly</button>
          <button data-range="year">Annual</button>
        </div>
        <canvas id="calChart" height="220"></canvas>
      </div>
    </section>

    <section class="card">
      <h2>Data & Settings</h2>
      <div class="row-3">
        <div>
          <label class="muted">Auto‑backup every</label>
          <select id="backupInterval">
            <option value="0">Off</option>
            <option value="3">3 days</option>
            <option value="7" selected>7 days</option>
            <option value="14">14 days</option>
            <option value="30">30 days</option>
          </select>
        </div>
        <div>
          <label class="muted">Theme</label>
          <select id="themeSelect">
            <option value="system">System</option>
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </div>
        <div style="align-self:end">
          <button id="backupNow">Backup Now</button>
        </div>
      </div>

      <div class="btns" style="margin-top:10px;">
        <button id="exportJson">Export JSON</button>
        <button id="exportCsv">Export CSV</button>
        <label class="muted" for="importFile" style="align-self:center;">Import JSON</label>
        <input id="importFile" type="file" accept="application/json" />
      </div>
      <table class="table" id="dataTable">
        <thead><tr><th>Date</th><th>Calories</th><th>Weight</th><th>Notes</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="muted">Data is stored locally in your browser. If you clear website data, it's gone—export or enable auto‑backup.</div>
    </section>
  </main>

  <div class="footer">Tip: Add this to your phone’s Home Screen for app‑like behavior (Safari: Share → Add to Home Screen).</div>

  <script>
    const STORAGE_KEY = "ct_entries_v1";
    const PREF_KEY = "ct_prefs_v1"; // { theme: 'system'|'dark'|'light', backupDays: number, lastBackupISO: 'YYYY-MM-DD' }
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function todayISO() {
      const d = new Date();
      const tz = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      return tz.toISOString().slice(0,10);
    }

    function loadEntries() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch { return []; }
    }
    function saveEntries(arr) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function loadPrefs() {
      let p = { theme: "system", backupDays: 7, lastBackupISO: "" };
      try {
        const raw = JSON.parse(localStorage.getItem(PREF_KEY) || "{}");
        p = { ...p, ...raw };
      } catch {}
      return p;
    }
    function savePrefs(p) {
      localStorage.setItem(PREF_KEY, JSON.stringify(p));
    }

    function applyTheme(themePref) {
      const root = document.documentElement;
      let mode = themePref;
      if (themePref === "system") {
        mode = window.matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";
      }
      if (mode === "light") root.classList.add("light"); else root.classList.remove("light");
      // Update meta theme color for mobile
      const meta = document.querySelector('meta[name="theme-color"]');
      meta?.setAttribute("content", mode === "light" ? "#ffffff" : "#111111");
    }

    function upsertToday() {
      const date = $("#date").value;
      const cal = parseInt($("#calories").value || "0", 10);
      const wt = parseFloat($("#weight").value || "NaN");
      const notes = $("#notes").value || "";
      if (!date) return alert("Date missing.");
      if (!cal && isNaN(wt)) return alert("Add calories or weight (or both).");
      const entries = loadEntries().filter(e => e && e.date);
      const idx = entries.findIndex(e => e.date === date);
      const obj = { date, calories: cal||null, weight: isNaN(wt)? null : wt, notes };
      if (idx >= 0) entries[idx] = obj; else entries.push(obj);
      entries.sort((a,b) => a.date.localeCompare(b.date));
      saveEntries(entries);
      maybeAutoBackup(); // auto-backup on save
      renderAll();
    }

    function undoLast() {
      const entries = loadEntries();
      if (!entries.length) return;
      if (!confirm("Undo last entry?")) return;
      entries.pop();
      saveEntries(entries);
      renderAll();
    }

    function clearAll() {
      if (!confirm("This deletes ALL entries permanently. Export/backup first.")) return;
      saveEntries([]);
      renderAll();
    }

    function loadTodayIntoForm() {
      const entries = loadEntries();
      const date = $("#date").value;
      const e = entries.find(x => x.date === date);
      if (!e) { alert("No entry for today yet."); return; }
      $("#calories").value = e.calories ?? "";
      $("#weight").value = (e.weight ?? "");
      $("#notes").value = e.notes ?? "";
    }

    function renderTable() {
      const tbody = $("#dataTable tbody");
      tbody.innerHTML = "";
      const entries = loadEntries();
      for (const e of entries) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${e.date}</td><td>${e.calories ?? ""}</td><td>${e.weight ?? ""}</td><td>${e.notes ?? ""}</td>`;
        tbody.appendChild(tr);
      }
    }

    function mean(arr) { return arr.length ? arr.reduce((a,b)=>a+b,0) / arr.length : NaN; }

    function lastNDays(entries, n) {
      if (!entries.length) return [];
      const end = new Date(entries[entries.length-1].date);
      const start = new Date(end); start.setDate(start.getDate() - (n-1));
      return entries.filter(e => new Date(e.date) >= start && new Date(e.date) <= end);
    }

    function renderKPIs() {
      const entries = loadEntries();
      $("#entryCount").textContent = entries.length;
      if (!entries.length) { $("#avg7Cal").textContent = "—"; $("#delta7Wt").textContent = "—"; return; }
      const last7 = lastNDays(entries, 7);
      const cals = last7.map(e=>e.calories).filter(x=>Number.isFinite(x));
      const avg = mean(cals);
      $("#avg7Cal").textContent = Number.isFinite(avg) ? Math.round(avg) : "—";

      const firstWt = last7.find(e=>Number.isFinite(e.weight));
      const lastWt = [...last7].reverse().find(e=>Number.isFinite(e.weight));
      const delta = (firstWt && lastWt) ? (lastWt.weight - firstWt.weight) : NaN;
      $("#delta7Wt").textContent = Number.isFinite(delta) ? (delta>0? "+" : "") + delta.toFixed(1) : "—";
    }

    let weightChart, calChart;

    function renderWeightChart() {
      const ctx = $("#weightChart");
      const entries = loadEntries();
      const data = entries.filter(e=>Number.isFinite(e.weight)).map(e => ({ x: e.date, y: e.weight }));
      if (weightChart) { weightChart.destroy(); }
      weightChart = new Chart(ctx, {
        type: "line",
        data: { datasets: [{
          label: "Weight (lbs)",
          data,
          tension: 0.25,
          pointRadius: 2
        }]},
        options: {
          responsive: true,
          scales: {
            x: { type: "time", time: { unit: "day" } },
            y: { beginAtZero: false }
          },
          plugins: {
            legend: { display: true }
          }
        }
      });
    }

    function groupBy(entries, period) {
      const map = new Map();
      for (const e of entries) {
        if (!Number.isFinite(e.calories)) continue;
        const d = luxon.DateTime.fromISO(e.date);
        let key;
        if (period === "week") { key = d.startOf("week").toISODate();
        } else if (period === "month") { key = d.startOf("month").toISODate();
        } else { key = d.startOf("year").toISODate(); }
        map.set(key, (map.get(key) || 0) + e.calories);
      }
      return [...map.entries()].map(([k,v])=>({ x:k, y:v })).sort((a,b)=>a.x.localeCompare(b.x));
    }

    function renderCalChart(period="week") {
      const ctx = $("#calChart");
      const entries = loadEntries();
      const rows = groupBy(entries, period);
      if (calChart) calChart.destroy();
      calChart = new Chart(ctx, {
        type: "bar",
        data: { datasets: [{ label: `Calories per ${period}`, data: rows }] },
        options: {
          responsive: true,
          scales: {
            x: { type: "time", time: { unit: period==="week" ? "week" : (period==="month" ? "month" : "year") } },
            y: { beginAtZero: true }
          },
          plugins: { legend: { display: true } }
        }
      });
    }

    // ---------- Export / Import ----------
    function exportJSON(withAuto=false) {
      const data = JSON.stringify(loadEntries(), null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "calorie_weight_data.json";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      if (withAuto) {
        const p = loadPrefs(); p.lastBackupISO = todayISO(); savePrefs(p);
      }
    }
    function exportCSV() {
      const entries = loadEntries();
      const header = "date,calories,weight,notes\n";
      const lines = entries.map(e => [e.date, e.calories ?? "", e.weight ?? "", (e.notes ?? "").replaceAll(",", ";")].join(","));
      const blob = new Blob([header + lines.join("\n")], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "calorie_weight_data.csv";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    function importJSON(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const arr = JSON.parse(reader.result);
          if (!Array.isArray(arr)) throw new Error("Invalid file");
          const clean = arr.map(e => ({
            date: e.date,
            calories: Number.isFinite(+e.calories) ? +e.calories : null,
            weight: Number.isFinite(+e.weight) ? +e.weight : null,
            notes: e.notes || ""
          })).filter(e => e.date);
          const cur = loadEntries().filter(e=>e && e.date);
          const map = new Map(cur.map(e => [e.date, e]));
          for (const e of clean) map.set(e.date, e);
          const merged = [...map.values()].sort((a,b)=>a.date.localeCompare(b.date));
          saveEntries(merged);
          renderAll();
          alert("Import OK");
        } catch (err) { alert("Import failed: " + err.message); }
      };
      reader.readAsText(file);
    }

    // ---------- Auto-backup ----------
    function maybeAutoBackup() {
      const p = loadPrefs();
      const days = Number(p.backupDays || 0);
      if (!days) return;
      const last = p.lastBackupISO ? new Date(p.lastBackupISO) : null;
      const today = new Date(todayISO());
      if (!last) { // first run with auto-backup enabled: do an initial backup
        exportJSON(true);
        return;
      }
      const diff = Math.floor((today - last) / 86400000);
      if (diff >= days) exportJSON(true);
    }

    // ---------- Theme & Pref UI ----------
    function initPrefsUI() {
      const p = loadPrefs();
      // theme select
      $("#themeSelect").value = p.theme || "system";
      $("#themeSelect").addEventListener("change", () => {
        const prefs = loadPrefs();
        prefs.theme = $("#themeSelect").value;
        savePrefs(prefs);
        applyTheme(prefs.theme);
      });
      // header toggle button does a quick flip between dark/light (ignores system)
      $("#themeToggle").addEventListener("click", () => {
        const prefs = loadPrefs();
        const current = (prefs.theme === "system") ? (window.matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark") : prefs.theme;
        const next = current === "light" ? "dark" : "light";
        prefs.theme = next;
        savePrefs(prefs);
        $("#themeSelect").value = next;
        applyTheme(next);
      });
      applyTheme(p.theme || "system");

      // backup interval
      $("#backupInterval").value = String(p.backupDays ?? 7);
      $("#backupInterval").addEventListener("change", () => {
        const prefs = loadPrefs();
        prefs.backupDays = Number($("#backupInterval").value);
        savePrefs(prefs);
        if (prefs.backupDays) maybeAutoBackup();
      });
      $("#backupNow").addEventListener("click", () => exportJSON(true));
    }

    // ---------- View toggles & render ----------
    let currentPeriod = "week";
    function hookEvents() {
      $("#saveBtn").addEventListener("click", upsertToday);
      $("#editBtn").addEventListener("click", loadTodayIntoForm);
      $("#undoBtn").addEventListener("click", undoLast);
      $("#clearBtn").addEventListener("click", clearAll);

      $("#exportJson").addEventListener("click", () => exportJSON(false));
      $("#exportCsv").addEventListener("click", exportCSV);
      $("#importFile").addEventListener("change", (e)=> {
        const f = e.target.files?.[0];
        if (f) importJSON(f);
      });

      $("#showWeight").addEventListener("click", () => {
        $("#showWeight").classList.add("active");
        $("#showCalories").classList.remove("active");
        $("#weightPanel").style.display = "";
        $("#calPanel").style.display = "none";
        renderWeightChart();
      });
      $("#showCalories").addEventListener("click", () => {
        $("#showCalories").classList.add("active");
        $("#showWeight").classList.remove("active");
        $("#weightPanel").style.display = "none";
        $("#calPanel").style.display = "";
        renderCalChart(currentPeriod);
      });

      $$("#calPanel .toggle-group button").forEach(btn => {
        btn.addEventListener("click", () => {
          $$("#calPanel .toggle-group button").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          currentPeriod = btn.dataset.range;
          renderCalChart(currentPeriod);
        });
      });
    }

    function renderAll() {
      renderTable();
      renderKPIs();
      if ($("#weightPanel").style.display !== "none") renderWeightChart();
      else renderCalChart(currentPeriod);
    }

    // Init
    document.addEventListener("DOMContentLoaded", () => {
      $("#date").value = todayISO();
      initPrefsUI();
      hookEvents();
      renderAll();
      maybeAutoBackup(); // auto-backup check on load
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").catch(()=>{});
      }
    });
  </script>
</body>
</html>
